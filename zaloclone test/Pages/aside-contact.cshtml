@page
@model Server.Pages.aside_contactModel
@{
    Layout = "_LayoutContact";
}

<aside class="flex-column aside-container-msg">
    <header class="flex-align-center aside-contact-head">
        <img class="aside-contact-head-img" src="https://cdn-icons-png.flaticon.com/512/77/77543.png" alt="">
        <div class="aside-contact-name">Danh sách bạn bè</div>
    </header>

    <div class="contact">
        <div class="flex-align-center contact-list-title">
            <span>Bạn bè</span>
            <span>&nbsp;(@(Model.Friends?.Count ?? 0))</span>
        </div>

        <div class="cont-contact">
            <div class="contact-filter">
                <div class="flex-justify-center search contact-search">
                    <button class="flex-align-center search-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <input class="search-input" type="text" placeholder="Tìm bạn" id="searchInput">
                    <button class="flex-align-center clear-icon" id="clearSearch">
                        <i class="fa-solid fa-circle-xmark"></i>
                    </button>
                </div>
                <div class="flex-align-center wrapper-filter">
                    <select id="sortOrder" class="contact-filter-select">
                        <option value="name_asc">Tên (A-Z)</option>
                        <option value="name_desc">Tên (Z-A)</option>
                        <option value="date_asc">Cũ nhất</option>
                        <option value="date_desc">Mới nhất</option>
                    </select>
                    <select id="filterType" class="contact-filter-select">
                        <option value="all">Tất Cả</option>
                        <option value="online">Đang hoạt động</option>
                        <option value="blocked">Đã chặn</option>
                    </select>
                </div>
            </div>

            <div id="friendsList">
                @if (Model.Friends != null)
                {
                    foreach (var friend in Model.Friends)
                    {
                        <div class="flex-align-center contact-item" data-friend-id="@friend.UserId">
                            <div style="position: relative;">
                                @{
                                    string? avatar = friend.Avatar;
                                    if (string.IsNullOrEmpty(avatar)) avatar = "default-avatar.png";
                                }
                                <img class="avatar-img friend-avatar" src="/img/@avatar" alt="">
                                @if (friend.IsOnline)
                                {
                                    <div class="friend-online"><i class="fa-solid fa-circle"></i></div>
                                }
                            </div>
                            <img class="avatar-img friend-avatar" src="/img/@(string.IsNullOrEmpty(friend.Avatar) ? "/img/default-avatar.png" : friend.Avatar)" alt="">
                            <div class="flex-align-center-between friend-info">
                                <span class="friend-name">@friend.Username</span>
                                @if (friend.IsOnline)
                                {
                                    <span class="friend-status online">Online</span>
                                }
                                <button type="button" class="btn-search-add friend-more" onclick="openFriendOptions(this)">
                                    <i class="fa-solid fa-ellipsis friend-more-icon"></i>
                                </button>
                                <div class="friend-options" style="display: none;">
                                    <ul>
                                        @if (friend.IsBlocked)
                                        {
                                            <li onclick="unblockFriend('@friend.UserId')">Bỏ chặn</li>
                                        }
                                        else
                                        {
                                            <li onclick="blockFriend('@friend.UserId')">Chặn</li>
                                        }
                                        <li onclick="deleteFriend('@friend.UserId')" class="danger">Xóa bạn</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</aside>

@section Scripts {
    <script>
        // Filter friends
        function filterFriends() {
            const searchTerm = document.getElementById('searchInput').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const filterType = document.getElementById('filterType').value;

            const filter = {
                searchTerm: searchTerm,
                sortOrder: sortOrder,
                filterType: filterType
            };

            fetch('?handler=Filter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(filter)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        updateFriendsList(result.data);
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra khi lọc danh sách bạn bè');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Có lỗi xảy ra khi lọc danh sách bạn bè');
                });
        }

        // Block friend
        function blockFriend(friendId) {
            if (confirm('Bạn có chắc chắn muốn chặn người dùng này không?')) {
                fetch('?handler=BlockFriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ userId: friendId })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            filterFriends();
                        }
                        showToast(result.message);
                    });
            }
        }

        // Unblock friend
        function unblockFriend(friendId) {
            if (confirm('Bạn có chắc chắn muốn bỏ chặn người dùng này không?')) {
                fetch('?handler=UnblockFriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ userId: friendId })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            filterFriends();
                        }
                        showToast(result.message);
                    });
            }
        }

        // Delete friend
        function deleteFriend(friendId) {
            if (confirm('Bạn có chắc chắn muốn xóa bạn bè không?')) {
                fetch('?handler=DeleteFriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ friendId: friendId })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.success) {
                            filterFriends();
                        }
                        showToast(result.message);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Có lỗi xảy ra khi xóa bạn bè');
                    });
            }
        }

        // Helper functions
        function updateFriendsList(friends) {
            if (!Array.isArray(friends)) {
                console.error('Expected friends to be an array, got:', friends);
                return;
            }

            const container = document.getElementById('friendsList');
            container.innerHTML = '';

            friends.forEach(friend => {
                try {
                    const friendElement = createFriendElement(friend);
                    container.appendChild(friendElement);
                } catch (error) {
                    console.error('Error creating friend element:', error);
                }
            });
        }

        function createFriendElement(friend) {
            const div = document.createElement('div');
            div.className = 'flex-align-center contact-item';
            div.setAttribute('data-friend-id', friend.userId);

            const avatar = friend.avatar || '/img/default-avatar.png';

            div.innerHTML = `
                                <img class="avatar-img friend-avatar" src="${avatar}" alt="">
                                <div class="flex-align-center-between friend-info">
                                    <span class="friend-name">${friend.username}</span>
                                    ${friend.isOnline ? '<span class="friend-status online">Online</span>' : ''}
                                    <button type="button" class="btn-search-add friend-more" onclick="openFriendOptions(this)">
                                        <i class="fa-solid fa-ellipsis friend-more-icon"></i>
                                    </button>
                                    <div class="friend-options" style="display: none;">
                                        <ul>
                                            ${friend.isBlocked ?
                    '<li onclick="unblockFriend(\'' + friend.userId + '\')">Bỏ chặn</li>' :
                    '<li onclick="blockFriend(\'' + friend.userId + '\')">Chặn</li>'
                }
                                            <li onclick="deleteFriend('${friend.userId}')" class="danger">Xóa bạn</li>
                                        </ul>
                                    </div>
                                </div>
                            `;

            return div;
        }

        function openFriendOptions(button) {
            document.querySelectorAll('.friend-options').forEach(menu => {
                if (menu !== button.nextElementSibling) {
                    menu.style.display = 'none';
                }
            });

            const optionsMenu = button.nextElementSibling;
            optionsMenu.style.display = optionsMenu.style.display === 'none' ? 'block' : 'none';
        }

        document.addEventListener('click', function (event) {
            if (!event.target.closest('.friend-more')) {
                document.querySelectorAll('.friend-options').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }, 100);
        }

        const debouncedFilter = debounce(() => filterFriends(), 300);
        document.getElementById('searchInput').addEventListener('input', debouncedFilter);
        document.getElementById('sortOrder').addEventListener('change', filterFriends);
        document.getElementById('filterType').addEventListener('change', filterFriends);
        document.getElementById('clearSearch').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            filterFriends();
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            filterFriends();
        });
    </script>
}